<!DOCTYPE html>
<meta charset="utf-8" />

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script
    type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.js"
  ></script>
  <link
    rel="stylesheet"
    type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/select2.min.css"
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="style.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;700;900&display=swap"
    rel="stylesheet"
  />









  
  <div id="graph"></div>
  <div id="block_container">
    
    <h1>CMMM—Glossary</h1>
    <p>Search:</p>
    <div id="searchName" aria-label="hello"></div>
  </div>
  <div id="definitions">
    <div id="def" class ="welcome"> Welcome to the CMMM Glossary. This is the info text. It disappears after clicking the diagram. You can zoom in and out with your fingers. </br></br>CMMM is a practice-oriented research project that is designed to support existing civil society movements in their struggle for profound transformation towards more just societies and cities. It believes that real change requires reshuffling existing power relations, which is what many on-the-ground mobilisers are trying to do. While there are many tools being developed and employed, in this project we focus on the tool of Critical Mapping (CM) which we consider an ‘act of power’.</div>
  </div>
  <div id="filters"> 
    <div id="myBtnContainer">Filter Source by different definitions: 
      <button id="btn1" class="btn btn-act" > Activists/Media</button>
      <button id="btn2" class="btn btn-cmmm"> CMMM Wall</button>
      <button id="btn3" class="btn btn-scho" > Scholarly</button>
      <button id="btn4" class="btn btn-inst" > Institutional</button>
    </div>
  </div>













  <script>

$(function () {
    $("#btn1").on("click", function () {

        $("#btn1").addClass("active");
    });
    $(document).on("click", function (e) {
        if (e.target.id != "btn1" && !$(e.target).parents("#filters").length) {
            $("#btn1").removeClass("active");
        }
    });
});

$(function () {
    $("#btn2").on("click", function () {

        $("#btn2").addClass("active");
    });
    $(document).on("click", function (e) {
        if (e.target.id != "btn2" && !$(e.target).closest("#filters").length) {
            $("#btn2").removeClass("active");
        }
    });
});

$(function () {
    $("#btn3").on("click", function () {

        $("#btn3").addClass("active");
    });
    $(document).on("click", function (e) {
        if (e.target.id != "btn3" && !$(e.target).closest("#filters").length) {
            $("#btn3").removeClass("active");
        }
    });
});


$(function () {
    $("#btn4").on("click", function () {

        $("#btn4").addClass("active");
    });
    $(document).on("click", function (e) {
        if (e.target.id != "btn4" && !$(e.target).closest("#filters").length) {
            $("#btn4").removeClass("active");
        }
    });
});




    //SEARCH FUNCTIONALITY
    //===============================================
    function select2DataCollectName(d) {
      if (d.children) d.children.forEach(select2DataCollectName);
      else if (d._children) d._children.forEach(select2DataCollectName);
      select2Data.push(d.name);
    }
    //===============================================
    function searchTree(d) {
      if (d.children) d.children.forEach(searchTree);
      else if (d._children) d._children.forEach(searchTree);
      var searchFieldValue = eval(searchField);
      if (searchFieldValue && searchFieldValue.match(searchText)) {
        // Walk parent chain
        var ancestors = [];
        var parent = d;
        while (typeof parent !== "undefined") {
          ancestors.push(parent);
          //    console.log(parent);
          parent.class = "found";
          parent = parent.parent;
        }
        //  console.log(ancestors);
      }
    }
    //===============================================
    function clearAll(d) {
      d.class = "";
      if (d.children) d.children.forEach(clearAll);
      else if (d._children) d._children.forEach(clearAll);
    }
    //===============================================
    function collapse(d) {
      if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
      }
    }
    //===============================================
    function collapseAllNotFound(d) {
      if (d.children) {
        if (d.class !== "found") {
          d._children = d.children;
          d._children.forEach(collapseAllNotFound);
          d.children = null;
        } else d.children.forEach(collapseAllNotFound);
      }
    }
    //===============================================
    function expandAll(d) {
      if (d._children) {
        d.children = d._children;
        d.children.forEach(expandAll);
        d._children = null;
      } else if (d.children) d.children.forEach(expandAll);
    }
    //===============================================
    function tick() {
      link
        .attr("x1", function (d) {
          return d.source.x;
        })
        .attr("y1", function (d) {
          return d.source.y;
        })
        .attr("x2", function (d) {
          return d.target.x;
        })
        .attr("y2", function (d) {
          return d.target.y;
        });

      node.attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
    }
    //===============================================
    // function color(d) {
    //   return d._children
    //     ? "#3182bd" // collapsed package
    //     : d.children
    //     ? "#c6dbef" // expanded package
    //     : "#fd8d3c"; // leaf node
    // }
    //===============================================
    // Toggle children on click.
    function click(d) {
      if (d3.event.defaultPrevented) return; // ignore drag
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update(d);
      $("#searchName").select2("val", "");
    }
    //===============================================
    $("#searchName").on("select2-selecting", function (e) {
      clearAll(root);
      expandAll(root);
      update(root);

      searchField = "d.name";
      searchText = e.object.text;
      searchTree(root);
      //   root.children.forEach(collapseAllNotFound);
      update(root);
    });

    // Returns a list of all nodes under the root.
    function flatten(root) {
      var nodes = [],
        i = 0;

      function recurse(node) {
        if (node.children) node.children.forEach(recurse);
        if (!node.id) node.id = ++i;
        nodes.push(node);
      }

      recurse(root);
      return nodes;
    }
    //GRAPH ARCHITECTURE
    //===============================================
    var width = 1280,
      height = 900,
      duration = 0,
      root;

    var force = d3.layout
      .force()
      .linkDistance(30)
      .charge(-900)
      .size([640, 450])
      .gravity(0.1)
      .on("tick", tick);

      function zooming(d) {        
  svg.attr("transform",
      "translate(" + d3.event.translate + ")"+ " scale(" + d3.event.scale + ")");
}

var x = d3.scale.linear()
    .domain([0, width])
    .range([0, width]);

var y = d3.scale.linear()
    .domain([0, height])
    .range([height, 0]);

    var zoom = d3.behavior.zoom().translate([250,100]).scale(.5,.5);


    var svg = d3
      .select("#graph")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .call(zoom.on("zoom", zooming))
        .append('g')
        .attr("transform","translate(250,100)scale(.5,.5)");
      

    var link = svg.selectAll(".link"),
      node = svg.selectAll(".node");

    d3.json("database.json", function (error, json) {
      root = json;
      update();

      select2Data = [];
      select2DataCollectName(root);
      select2DataObject = [];
      select2Data
        .sort(function (a, b) {
          if (a > b) return 1; // sort
          if (a < b) return -1;
          return 0;
        })
        .filter(function (item, i, ar) {
          return ar.indexOf(item) === i;
        }) // remove duplicate items
        .filter(function (item, i, ar) {
          select2DataObject.push({
            id: i,
            text: item,
          });
        });
      select2Data
        .sort(function (a, b) {
          if (a > b) return 1; // sort
          if (a < b) return -1;
          return 0;
        })
        .filter(function (item, i, ar) {
          return ar.indexOf(item) === i;
        }) // remove duplicate items
        .filter(function (item, i, ar) {
          select2DataObject.push({
            id: i,
            text: item,
          });
        });

      $("#searchName").select2({
        data: select2DataObject,
        containerCssClass: "search",
      });

      function collapse(d) {
        if (d.children) {
          d._children = d.children;
          d._children.forEach(collapse);
          d.children = null;
        }
      }

      //  root.children.forEach(collapse);
      update(root);
    });

    function update() {
      var nodes = flatten(root),
        links = d3.layout.tree().links(nodes);
        console.log(root)

      // Restart the force layout.
      force.nodes(nodes).links(links).start();

      // Update nodes.
      node = node.data(nodes, function (d) {
        return d.id;
      });

      var nodeEnter = node
        .enter()
        .append("g")
        .attr("class", "node")
        .on("click", click)
        .call(force.drag);

      nodeEnter.append("circle").attr("r", 15).style("fill", "white").style("opacity", 0.01);

      nodeEnter
        .append("text")
        .attr("dy", "0.5em")
        .attr("dx", "0em")
        
        .html(function (d) {
          return d.name;
        })

        .attr("id", function (d) {
          if (d.style === "bold") {
            return "big"; //red
          } else if (d.style === "medium") {
            return "medium"; //red
          } else if (d.style === "small") {
            return "small"; //red
          } 


        });

      // Transition nodes to their new position.
      var nodeUpdate = node.transition().duration(duration);

      nodeUpdate
        .select("text")
        .style("font", function (d) {
          if (d.style = "bold") {
            console.log(d.style);
            return "20px"; //red
          }
        })
        //  .style("fill", color)
        // .style("fill", function (d) {
        //   if (d.class === "found") {
        //     return "#ff4136"; //red
        //   } else if (d._children) {
        //     return "lightsteelblue";
        //   } else {
        //     return "#fff";
        //   }
        // })
        .style("fill", function (d) {
          if (d.class === "found") {
            return "#fa0f0c"; //red
          }
        });

      // Transition exiting nodes to the parent's new position.
      var nodeExit = node.exit().transition().duration(duration).remove();

      // Update links.
      link = link.data(links, function (d) {
        return d.target.id;
      });

      link
        .enter()
        .insert("line", ".node")
        .attr("class", "link")
        .style("stroke", function (d) {
          return d.target.level;
        });

      // Transition links to their new position.
      link
        .transition()
        .duration(duration)
        //    .attr("d", diagonal)
        .style("stroke", function (d) {
          if (d.target.class === "found") {
            return "#ff4136";
          }
        });

      // Content

      node.on("click", function (d) {

          d3.select(".selected").classed("selected", false);
          d3.select(this).classed("selected", true);
          d3.selectAll("#def").remove();
          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category.replace(/\s+/g, ""))
          .html('<h2>' + d.name + ", " + '<span id="year">' + d.year + '</span>' + '</h2>' + 
          '<span id='+d.category.replace(/\s+/g, "")+"sp"+'>' + d.category + '</span>' +
          '<p>' + d.Definiton +'</p>' +
          '<p><b><em>' + "by: " + d.Author + '</em></b></p>'+
          '<p><em>' + d.Reference +'<p><em>'
          );

          
          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category_a.replace(/\s+/g, ""))
          .html('<h2>' + d.name_a + ", " + '<span id="year">' + d.year_a + '</span>' + '</h2>' + 
          '<span id='+d.category_a.replace(/\s+/g, "")+"sp"+'>' + d.category_a + '</span>' +
          '<p>' + d.Definiton_a +'</p>' +
          '<p><b><em>' + "by: " + d.Author_a + '</em></b></p>'+
          '<p><em>' + d.Reference_a +'<p><em>'
          );

          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category_b.replace(/\s+/g, ""))
          .html('<h2>' + d.name_b + ", " + '<span id="year">' + d.year_b + '</span>' + '</h2>' + 
          '<span id='+d.category_b.replace(/\s+/g, "")+"sp"+'>' + d.category_b + '</span>' +
          '<p>' + d.Definiton_a +'</p>' +
          '<p><b><em>' + "by: " + d.Author_b + '</em></b></p>'+
          '<p><em>' + d.Reference_b +'<p><em>'
          );
        
          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category_c.replace(/\s+/g, ""))
          .html('<h2>' + d.name_c + ", " + '<span id="year">' + d.year_c + '</span>' + '</h2>' + 
          '<span id='+d.category_c.replace(/\s+/g, "")+"sp"+'>' + d.category_c + '</span>' +
          '<p>' + d.Definiton_c +'</p>' +
          '<p><b><em>' + "by: " + d.Author_c + '</em></b></p>'+
          '<p><em>' + d.Reference_c +'<p><em>'
          );
          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category_d.replace(/\s+/g, ""))
          .html('<h2>' + d.name_d + ", " + '<span id="year">' + d.year_d + '</span>' + '</h2>' + 
          '<span id='+d.category_d.replace(/\s+/g, "")+"sp"+'>' + d.category_d + '</span>' +
          '<p>' + d.Definiton_d +'</p>' +
          '<p><b><em>' + "by: " + d.Author_d + '</em></b></p>'+
          '<p><em>' + d.Reference_d +'<p><em>'
          );

          d3.select("#definitions")
          .append("div")
          .attr("id", "def")
          .attr("class", d.category_f.replace(/\s+/g, ""))
          .html('<h2>' + d.name_f + ", " + '<span id="year">' + d.year_f + '</span>' + '</h2>' + 
          '<span id='+d.category_f.replace(/\s+/g, "")+"sp"+'>' + d.category_f + '</span>' +
          '<p>' + d.Definiton_f +'</p>' +
          '<p><b><em>' + "by: " + d.Author_f + '</em></b></p>'+
          '<p><em>' + d.Reference_f +'<p><em>'
          );

      });


            

var button = d3.select(".btn-cmmm")
button.on("click",function(d){
  d3.selectAll(".CMMMWALL").remove();
});

var buttona = d3.select(".btn-act")
buttona.on("click",function(d){
  d3.selectAll(".Activists").remove();
});

var buttonb = d3.select(".btn-scho")
buttonb.on("click",function(d){
  d3.selectAll(".SCHOLARLY").remove();
});

var buttonc = d3.select(".btn-inst")
buttonc.on("click",function(d){
  d3.selectAll(".INSTITUTIONAL").remove();
});

      // Transition exiting nodes to the parent's new position.
      link.exit().transition().duration(duration).remove();

      // Stash the old positions for transition.
      nodes.forEach(function (d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }
    
  </script>
</body>
